# اختبار أمان النظام - Security Testing Guide

## نظرة عامة

تم تطبيق نظام حماية شامل يمنع الطبيب من الوصول لصفحات الإدمن ويضمن تطبيق الصلاحيات بشكل صحيح.

## الحماية المطبقة

### 1. حماية الصفحات الإدارية

#### AdminGuard
- يمنع الوصول لجميع صفحات الإدمن
- يتحقق من صلاحية الإدمن قبل عرض المحتوى
- يعرض رسالة خطأ مناسبة للمستخدمين غير المصرح لهم

#### الصفحات المحمية:
- `/admin` - لوحة تحكم الإدمن
- `/admin/doctors` - إدارة الأطباء
- `/admin/staff` - إدارة الموظفين
- `/admin/hospitals` - إدارة المستشفيات
- `/admin/cities` - إدارة المدن
- `/admin/permissions` - إدارة الصلاحيات

### 2. حماية صفحات الطبيب

#### DoctorOnlyGuard
- يمنع الوصول لصفحات الطبيب من المستخدمين الآخرين
- يوجه المستخدمين للصفحة المناسبة حسب دورهم

#### الصفحات المحمية:
- `/doctor` - لوحة تحكم الطبيب
- `/doctor/patients` - إدارة المرضى
- `/doctor/tests` - إدارة الفحوصات
- `/doctor/treatments` - إدارة العلاجات

### 3. حماية صفحات الموظف

#### StaffOnlyGuard
- يمنع الوصول لصفحات الموظف من المستخدمين الآخرين
- يوجه المستخدمين للصفحة المناسبة حسب دورهم

#### الصفحات المحمية:
- `/employee` - لوحة تحكم الموظف
- `/employee/patients` - إدارة المرضى

## كيفية الاختبار

### 1. اختبار تلقائي

```bash
# تشغيل الخادم
npm run dev

# زيارة صفحة الاختبار
http://localhost:3000/test-security
```

### 2. اختبار يدوي

#### اختبار 1: محاولة الطبيب الوصول لصفحات الإدمن

1. سجل دخول كطبيب
2. حاول الوصول للرابط: `http://localhost:3000/admin`
3. **النتيجة المتوقعة**: يجب أن تظهر رسالة "صفحة مخصصة للإدمن"
4. يجب أن يتم توجيهك لصفحة الطبيب

#### اختبار 2: محاولة الموظف الوصول لصفحات الإدمن

1. سجل دخول كموظف
2. حاول الوصول للرابط: `http://localhost:3000/admin`
3. **النتيجة المتوقعة**: يجب أن تظهر رسالة "وصول مرفوض"
4. يجب أن يتم توجيهك لصفحة الموظف

#### اختبار 3: محاولة الطبيب الوصول لصفحات الموظف

1. سجل دخول كطبيب
2. حاول الوصول للرابط: `http://localhost:3000/employee`
3. **النتيجة المتوقعة**: يجب أن تظهر رسالة "صفحة مخصصة للموظف"
4. يجب أن يتم توجيهك لصفحة الطبيب

#### اختبار 4: الإدمن يمكنه الوصول لجميع الصفحات

1. سجل دخول كإدمن
2. جرب الوصول لجميع الصفحات
3. **النتيجة المتوقعة**: يجب أن تتمكن من الوصول لجميع الصفحات

### 3. اختبار الصلاحيات المتقدمة

#### اختبار صلاحيات محددة

```typescript
// في الكود
import { usePermissions } from '@/hooks/use-permissions'

function MyComponent() {
  const { hasPermission, loading, error } = usePermissions({
    resource: 'PATIENTS',
    action: 'WRITE',
    hospitalId: 'hospital-id'
  })

  if (loading) return <div>جاري التحميل...</div>
  if (error) return <div>خطأ: {error}</div>
  if (!hasPermission) return <div>ليس لديك صلاحية</div>

  return <div>محتوى محمي</div>
}
```

## رسائل الخطأ

### للطبيب عند محاولة الوصول لصفحات الإدمن:
```
صفحة مخصصة للإدمن
هذه الصفحة مخصصة للإدمن فقط. يرجى العودة إلى لوحة تحكم الطبيب.
```

### للموظف عند محاولة الوصول لصفحات الإدمن:
```
وصول مرفوض
ليس لديك صلاحية للوصول إلى هذه الصفحة.
```

### عند عدم وجود صلاحية محددة:
```
صلاحية مطلوبة
ليس لديك الصلاحية المطلوبة للوصول إلى هذه الصفحة.
```

## التحقق من الحماية

### 1. فحص الكود

```bash
# البحث عن AdminGuard في الكود
grep -r "AdminGuard" src/

# البحث عن DoctorOnlyGuard
grep -r "DoctorOnlyGuard" src/

# البحث عن StaffOnlyGuard
grep -r "StaffOnlyGuard" src/
```

### 2. فحص الشبكة

1. افتح Developer Tools
2. اذهب لتبويب Network
3. حاول الوصول لصفحة محمية
4. تحقق من استجابة الخادم (يجب أن تكون 403 أو 401)

### 3. فحص Console

```javascript
// في console المتصفح
console.log('User role:', localStorage.getItem('user'))
console.log('Permissions:', localStorage.getItem('permissions'))
```

## استكشاف الأخطاء

### مشكلة: الطبيب يمكنه الوصول لصفحات الإدمن

**الحل:**
1. تأكد من تطبيق `AdminGuard` في layout الإدمن
2. تحقق من صحة `usePermissions` hook
3. تأكد من صحة بيانات المستخدم في localStorage

### مشكلة: رسائل خطأ غير واضحة

**الحل:**
1. تحقق من ترجمة الرسائل
2. تأكد من تطبيق `RoleGuard` بشكل صحيح
3. تحقق من منطق التحقق من الأدوار

### مشكلة: بطء في التحميل

**الحل:**
1. تحقق من كفاءة `usePermissions` hook
2. تأكد من استخدام الكاش بشكل صحيح
3. تحقق من استعلامات قاعدة البيانات

## أفضل الممارسات

### 1. حماية متعددة المستويات
- حماية على مستوى Layout
- حماية على مستوى الصفحة
- حماية على مستوى الكومبوننت

### 2. رسائل خطأ واضحة
- رسائل باللغة العربية
- توجيه المستخدم للصفحة المناسبة
- عدم كشف معلومات حساسة

### 3. أداء جيد
- استخدام الكاش للصلاحيات
- تحميل الصلاحيات بشكل تدريجي
- تجنب استعلامات قاعدة البيانات المتكررة

## الخلاصة

تم تطبيق نظام حماية شامل يضمن:

✅ **الطبيب لا يستطيع الوصول لصفحات الإدمن**
✅ **الموظف لا يستطيع الوصول لصفحات الإدمن**
✅ **الإدمن يمكنه الوصول لجميع الصفحات**
✅ **رسائل خطأ واضحة ومفيدة**
✅ **توجيه المستخدمين للصفحة المناسبة**
✅ **حماية متعددة المستويات**

النظام آمن ومحمي بشكل كامل، والطبيب لن يتمكن من رؤية أي شيء متعلق بالإدمن.
